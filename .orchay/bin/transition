#!/bin/bash
#
# transition - 프로젝트 루트에서 transition.ts 실행
#
# 사용법: transition <task-id> <command> [options]
#
# 이 스크립트는 어떤 디렉토리에서 실행해도 프로젝트 루트를 찾아서
# .orchay/script/transition.ts를 실행합니다.
#

# 프로젝트 루트 찾기 (.orchay 디렉토리가 있는 곳)
find_project_root() {
    local dir="$PWD"

    while [[ "$dir" != "/" ]]; do
        if [[ -d "$dir/.orchay" ]]; then
            echo "$dir"
            return 0
        fi
        dir="$(dirname "$dir")"
    done

    # 루트에서도 체크
    if [[ -d "/.orchay" ]]; then
        echo "/"
        return 0
    fi

    return 1
}

# 프로젝트 루트 찾기
PROJECT_ROOT=$(find_project_root)

if [[ -z "$PROJECT_ROOT" ]]; then
    echo '{"success": false, "reason": "PROJECT_NOT_FOUND", "message": ".orchay 디렉토리를 찾을 수 없습니다"}' >&2
    exit 1
fi

SCRIPT_PATH="$PROJECT_ROOT/.orchay/script/transition.ts"

if [[ ! -f "$SCRIPT_PATH" ]]; then
    echo '{"success": false, "reason": "SCRIPT_NOT_FOUND", "message": "transition.ts 스크립트를 찾을 수 없습니다"}' >&2
    exit 1
fi

# 프로젝트 루트에서 스크립트 실행
cd "$PROJECT_ROOT" && npx tsx "$SCRIPT_PATH" "$@"
