# TSK-03-01 설계 리뷰 보고서

## 문서 정보

| 항목 | 내용 |
|------|------|
| Task ID | TSK-03-01 |
| Task명 | 메뉴 데이터 모델 |
| 리뷰 일자 | 2026-01-20 |
| 리뷰어 | claude-1 |
| 대상 문서 | 010-design.md, 025-traceability-matrix.md, 026-test-specification.md |

---

## 리뷰 요약

```
[wf:review] 설계 리뷰

Task: TSK-03-01 | 리뷰어: claude-1

 검증 대상:
├── 010-design.md ✅
├── 025-traceability-matrix.md ✅
└── 026-test-specification.md ✅

┌────────────────┬──────┬─────────────────────────────┐
│ 검증 영역      │ 평가 │ 비고                        │
├────────────────┼──────┼─────────────────────────────┤
│ 문서 완전성    │ WARN │ NFR 섹션 누락, 체크리스트 불일치 │
│ 요구사항 추적성│ WARN │ PRD 매핑 일부 불일치         │
│ 아키텍처       │ WARN │ 인덱스/캐싱 전략 미정의      │
│ 보안           │ FAIL │ 인증/입력검증 설계 보완 필요 │
│ 테스트 가능성  │ WARN │ E2E 상세명세 불완전          │
└────────────────┴──────┴─────────────────────────────┘

이슈 분포: P1(4) P2(9) P3(5) P4(3) P5(1) = 22건
```

---

## 이슈 요약

| 심각도 | 개수 | 설명 |
|--------|------|------|
| Critical | 1 | 보안: 메뉴 API 인증 미적용 |
| High | 8 | 아키텍처 3, 보안 3, 품질 2 |
| Medium | 10 | 아키텍처 4, 보안 3, 품질 3 |
| Low | 2 | 정보 노출, 테스트 중복 |
| Info | 1 | SQL Injection 방어 확인 |

---

## 1. 아키텍처 리뷰 이슈

### ARCH-01: 대량 메뉴 조회 시 성능 병목

**심각도**: High
**우선순위**: P2
**위치**: 010-design.md 섹션 7.3, 7.5

**문제**:
GET /api/menus는 모든 메뉴를 한 번에 조회하여 애플리케이션 레벨에서 트리로 변환합니다. 메뉴가 1000개 이상으로 증가할 경우:
1. N+1 쿼리 문제 발생 가능
2. 메모리 부하 증가
3. JSON 직렬화 오버헤드

**권장사항**:
1. Prisma 스키마에 인덱스 추가:
```prisma
@@index([parentId])
@@index([isActive, sortOrder])
@@index([parentId, sortOrder])
```
2. Redis 또는 메모리 캐시 도입 (TTL 5분)
3. PostgreSQL 전환 후 Recursive CTE 활용 검토

**영향**:
메뉴 수 증가에 따라 API 응답 시간이 선형적으로 증가

---

### ARCH-02: 인덱스 전략 미정의

**심각도**: High
**우선순위**: P2
**위치**: 010-design.md 섹션 7.3

**문제**:
현재 Prisma 스키마에는 `code` 필드의 unique 제약만 존재하며, 성능에 중요한 인덱스가 정의되어 있지 않습니다.

**권장사항**:
```prisma
model Menu {
  // ... 필드
  @@index([parentId])
  @@index([isActive])
  @@index([parentId, sortOrder])
  @@index([isActive, parentId, sortOrder])
  @@map("menus")
}
```

**영향**:
메뉴 수 증가에 따른 쿼리 성능 저하, 풀 테이블 스캔 발생

---

### ARCH-03: 순환 참조 방지 로직 부재

**심각도**: High
**우선순위**: P1
**위치**: 010-design.md 섹션 7.2

**문제**:
자기참조 관계에서 순환 참조를 방지하는 로직이 설계에 포함되지 않았습니다.
예: A의 부모가 B이고, B의 부모를 A로 설정하면 무한 루프 발생

**권장사항**:
서비스 레이어에 순환 참조 검증 함수 추가:
```typescript
async function validateNoCircularReference(menuId: number, newParentId: number | null): Promise<void> {
  if (!newParentId) return;
  if (menuId === newParentId) throw new BadRequestException('자기 자신을 부모로 지정할 수 없습니다');

  let currentId: number | null = newParentId;
  while (currentId) {
    if (currentId === menuId) {
      throw new BadRequestException('순환 참조: 자식 메뉴를 부모로 지정할 수 없습니다');
    }
    const menu = await prisma.menu.findUnique({ where: { id: currentId }, select: { parentId: true } });
    currentId = menu?.parentId ?? null;
  }
}
```

**영향**:
순환 참조 데이터 입력으로 인한 애플리케이션 무한 루프, 서버 다운 위험

---

### ARCH-04: OCP 부분 준수 - 메타데이터 확장성

**심각도**: Medium
**우선순위**: P3
**위치**: 010-design.md 섹션 7.1, 7.3

**문제**:
현재 Menu 모델은 기본 필드만 정의되어 있어, 향후 메타데이터 확장(description, badge, externalUrl 등) 시 스키마 수정과 마이그레이션이 반복적으로 필요합니다.

**권장사항**:
`metadata` JSON 필드 추가로 유연한 확장 지원:
```prisma
model Menu {
  // ... 기존 필드
  metadata  Json?    // 확장 속성 저장 (badge, description, etc.)
}
```

**영향**:
메뉴 기능 확장마다 DB 마이그레이션 필요, 배포 주기 증가

---

### ARCH-05: 다국어(i18n) 지원 확장 불가

**심각도**: Medium
**우선순위**: P3
**위치**: 010-design.md 섹션 7.1

**문제**:
`name` 필드가 단일 언어 문자열로 정의되어 있어, PRD 5.3 다국어 지원 요구사항 충족 시 스키마 재설계 필요

**권장사항**:
Phase 2 대비 설계 고려:
- 옵션 1: `nameI18n Json?` 필드 추가 `{"ko": "대시보드", "en": "Dashboard"}`
- 옵션 2: 별도 MenuTranslation 테이블 분리

**영향**:
다국어 지원 요구 시 대규모 스키마 변경과 데이터 마이그레이션 필요

---

### ARCH-06: 계층 깊이 제한 검증 로직 부재

**심각도**: Medium
**우선순위**: P2
**위치**: 010-design.md 섹션 8.1 BR-02

**문제**:
BR-02에서 "계층 구조는 최대 3단계"라는 비즈니스 규칙이 정의되어 있으나, 이를 강제하는 로직이 설계에 포함되지 않았습니다.

**권장사항**:
서비스 레이어에 계층 깊이 검증 함수 추가 (ARCH-03과 통합 가능)

**영향**:
잘못된 데이터 입력으로 인한 UI 렌더링 오류

---

### ARCH-07: 삭제 정책(Cascade) 미정의

**심각도**: Medium
**우선순위**: P2
**위치**: 010-design.md 섹션 7.3

**문제**:
Menu 삭제 시 RoleMenu 매핑에 대한 Cascade 정책이 정의되어 있지 않습니다.

**권장사항**:
```prisma
model RoleMenu {
  menu Menu @relation(fields: [menuId], references: [id], onDelete: Cascade)
}
```

**영향**:
메뉴 삭제 후 고아(orphan) RoleMenu 레코드 발생, 데이터 정합성 문제

---

## 2. 보안 리뷰 이슈

### SEC-01: 메뉴 API 인증 미적용

**심각도**: Critical
**우선순위**: P1
**OWASP 참조**: A01:2021 - Broken Access Control, A07:2021 - Identification and Authentication Failures

**문제**:
설계 문서의 `GET /api/menus` API가 인증 여부를 검증하지 않고 있습니다. UC-01 기본 흐름에 세션/토큰 검증 단계가 포함되어 있지 않습니다.

**권장사항**:
- API 엔드포인트에 인증 미들웨어 적용 필수
- 유즈케이스 기본 흐름에 인증 검증 단계 추가
- Auth.js 세션 검증을 첫 번째 단계로 명시

**영향**:
미인증 사용자가 시스템의 전체 메뉴 구조를 열람 가능, 정보 수집 공격에 취약

---

### SEC-02: 역할 기반 메뉴 필터링 미적용

**심각도**: High
**우선순위**: P1
**OWASP 참조**: A01:2021 - Broken Access Control

**문제**:
TSK-03-01 설계 범위에서 역할별 메뉴 필터링을 "제외"로 명시하고 있어, TSK-03-02 완료 전까지 모든 인증 사용자에게 전체 메뉴가 노출됩니다.

**권장사항**:
- TSK-03-01과 TSK-03-02를 동시 배포하도록 의존성 설정
- 또는 TSK-03-01 API 구현 시 임시로 빈 배열 반환

**영향**:
관리자 전용 메뉴 경로 노출, URL 직접 접근 공격 시도 가능

---

### SEC-03: path 필드 URL Injection 위험

**심각도**: High
**우선순위**: P1
**OWASP 참조**: A03:2021 - Injection

**문제**:
`path` 필드에 대한 검증이 없어 다음과 같은 악성 값이 저장될 수 있습니다:
- `javascript:alert('XSS')`
- `//evil.com/phishing`
- `/portal/../../../etc/passwd`

**권장사항**:
- path 필드는 반드시 `/portal/`로 시작하도록 강제
- 외부 URL, javascript: 프로토콜, Path traversal 문자 차단
- 정규식 검증: `^\/portal\/[a-z0-9\-\/]+$`

**영향**:
Open Redirect 공격, XSS 공격, 내부 시스템 경로 노출

---

### SEC-04: icon 필드 XSS 위험

**심각도**: Medium
**우선순위**: P2
**OWASP 참조**: A03:2021 - Injection (XSS)

**문제**:
`icon` 필드 값이 React 컴포넌트로 동적 렌더링될 때 XSS 취약점 발생 가능

**권장사항**:
- icon 필드는 허용 목록(allowlist) 기반으로 검증
- `@ant-design/icons`의 유효한 아이콘 이름만 허용

**영향**:
XSS 공격을 통한 세션 탈취, 악성 스크립트 실행

---

### SEC-05: 순환 참조 방지 누락

**심각도**: High
**우선순위**: P1
**OWASP 참조**: A04:2021 - Insecure Design

**문제**:
자기 참조 관계(`parentId`)에서 순환 참조를 방지하는 검증이 없습니다. (ARCH-03과 동일)

**권장사항**:
ARCH-03 권장사항 참조

**영향**:
무한 루프로 인한 서버 크래시 (DoS), 메모리 고갈

---

### SEC-06: 메뉴 구조 전체 노출로 인한 정보 수집

**심각도**: Medium
**우선순위**: P2
**OWASP 참조**: A04:2021 - Insecure Design

**문제**:
인증된 모든 사용자가 시스템의 전체 메뉴 구조(기능 목록, URL 패턴, 관리자 기능 위치)를 볼 수 있습니다.

**권장사항**:
- TSK-03-02 역할 필터링을 TSK-03-01과 동시 배포 필수
- 민감한 관리 메뉴는 별도 API로 분리 고려

**영향**:
공격자가 시스템 구조를 파악하여 타겟팅된 공격 수행 가능

---

### SEC-07: 입력 검증 정의 누락

**심각도**: Medium
**우선순위**: P2
**OWASP 참조**: A03:2021 - Injection

**문제**:
메뉴 CRUD 중 생성/수정에 대한 입력 검증 규칙이 명시되지 않았습니다.

**권장사항**:
- `code` 필드: 대문자 영문자, 숫자, 언더스코어만 허용 (`^[A-Z][A-Z0-9_]*$`)
- `name` 필드: 최대 길이 50자, HTML 특수문자 이스케이프
- `path` 필드: SEC-03 참조
- `icon` 필드: SEC-04 참조

**영향**:
잘못된 데이터가 DB에 저장되어 시스템 오동작 또는 보안 취약점

---

## 3. 품질 리뷰 이슈

### QA-01: 비기능 요구사항(NFR) 섹션 누락

**심각도**: High
**우선순위**: P1
**위치**: 010-design.md 전체

**문제**:
설계 문서에 성능, 보안, 가용성 관련 비기능 요구사항이 정의되어 있지 않습니다. PRD 섹션 5에서 명시한 NFR(페이지 로딩 3초 이내, JWT 인증 등)이 설계에 반영되지 않았습니다.

**권장사항**:
1. 섹션 추가: "비기능 요구사항"
2. 메뉴 API 응답 시간 목표 정의 (예: 200ms 이내)
3. 메뉴 데이터 캐싱 전략 명시

**영향**:
성능 테스트 기준 부재, 프로덕션 성능 이슈 대응 기준 없음

---

### QA-02: 에러 코드 체계 미정의

**심각도**: High
**우선순위**: P1
**위치**: 010-design.md 섹션 9

**문제**:
에러 처리 섹션에서 정의된 에러 상황이 2개뿐이며, 비즈니스 규칙 위반(중복 코드, 깊이 초과, 자식 존재)에 대한 에러 코드가 정의되어 있지 않습니다.

**권장사항**:
섹션 9.1에 다음 에러 상황 추가:

| 상황 | HTTP 상태 | 에러 코드 | 메시지 |
|------|----------|----------|--------|
| 중복 메뉴 코드 | 409 | DUPLICATE_MENU_CODE | 이미 존재하는 메뉴 코드입니다 |
| 계층 깊이 초과 | 400 | MAX_DEPTH_EXCEEDED | 메뉴 계층은 최대 3단계까지 허용됩니다 |
| 자식 메뉴 존재 | 400 | HAS_CHILDREN | 하위 메뉴가 있어 삭제할 수 없습니다 |
| 메뉴 미존재 | 404 | MENU_NOT_FOUND | 메뉴를 찾을 수 없습니다 |

**영향**:
프론트엔드 에러 처리 기준 부재, API 응답 형식 불일치

---

### QA-03: PRD 요구사항과 설계 매핑 불일치

**심각도**: Critical
**우선순위**: P1
**위치**: 025-traceability-matrix.md 섹션 1

**문제**:
1. FR-005 "메뉴 활성/비활성"이 PRD에 직접 명시되어 있지 않음
2. BR-003 "자식 메뉴가 있는 경우 부모 메뉴 삭제 불가"의 PRD 근거 부재

**권장사항**:
1. PRD에 해당 요구사항을 명시적으로 추가하거나
2. 설계 단계에서 도출된 규칙임을 명시

**영향**:
추적성 매트릭스 신뢰성 저하, 감사(Audit) 시 검증 문제

---

### QA-04: E2E 테스트 상세 명세 불완전

**심각도**: High
**우선순위**: P1
**위치**: 026-test-specification.md 섹션 3.2

**문제**:
E2E 테스트 7개 중 상세 명세가 작성된 것은 E2E-001, E2E-005 단 2개뿐입니다.

**권장사항**:
모든 E2E 테스트(E2E-002 ~ E2E-007)에 대해 상세 명세 작성

**영향**:
E2E 테스트 구현 일관성 저하, 커버리지 판단 어려움

---

### QA-05: 경계값 테스트 케이스 부족

**심각도**: High
**우선순위**: P1
**위치**: 026-test-specification.md 전체

**문제**:
경계값(Boundary Value) 테스트 케이스가 정의되어 있지 않습니다:
- sortOrder 최소/최대/음수 값
- code, name, path 필드 최대 길이
- 빈 문자열 입력
- 정확히 3단계 메뉴 생성

**권장사항**:
단위 테스트 추가:
- UT-010: sortOrder 경계값 테스트
- UT-011: 필드 길이 제한 테스트
- UT-012: 빈/null 입력 검증 테스트

**영향**:
입력 경계에서 발생하는 버그가 프로덕션에서 발견될 수 있음

---

### QA-06: 인터페이스 추적 범위 불일치

**심각도**: Medium
**우선순위**: P3
**위치**: 025-traceability-matrix.md 섹션 5

**문제**:
인터페이스 추적 테이블에 CRUD API(POST, PUT, DELETE)가 정의되어 있으나, 설계 문서 범위에서는 GET만 포함됨

**권장사항**:
설계 문서 범위를 수정하거나 추적 매트릭스에서 범위 외 API를 명시

**영향**:
구현 범위 혼란, 불필요한 API 구현 또는 필요한 API 누락

---

### QA-07: 문서 체크리스트 상태 불일치

**심각도**: Medium
**우선순위**: P2
**위치**: 010-design.md 섹션 12.2

**문제**:
체크리스트에서 "요구사항 추적 매트릭스"와 "테스트 명세서" 항목이 미완료([ ])로 표시되어 있으나, 실제로 해당 문서들은 이미 작성됨

**권장사항**:
체크리스트 항목을 `[x]`로 업데이트

**영향**:
작업 진행 상황 추적 오류

---

### QA-08: createdAt/updatedAt 타임스탬프 필드 누락

**심각도**: Medium
**우선순위**: P2
**위치**: 010-design.md 섹션 7.1, 7.3

**문제**:
Menu 테이블 스키마에 타임스탬프 필드가 정의되어 있지 않음

**권장사항**:
```prisma
createdAt DateTime @default(now())
updatedAt DateTime @updatedAt
```

**영향**:
메뉴 변경 이력 추적 불가, 운영 환경 문제 분석 어려움

---

## 우선순위별 조치 요약

### P1 (즉시 조치 - 구현 전 필수 수정)

| 이슈 ID | 영역 | 이슈 제목 |
|---------|------|----------|
| SEC-01 | 보안 | 메뉴 API 인증 미적용 |
| SEC-02 | 보안 | 역할 기반 메뉴 필터링 미적용 |
| SEC-03 | 보안 | path 필드 URL Injection 위험 |
| SEC-05/ARCH-03 | 보안/아키텍처 | 순환 참조 방지 누락 |
| QA-01 | 품질 | 비기능 요구사항 섹션 누락 |
| QA-02 | 품질 | 에러 코드 체계 미정의 |
| QA-03 | 품질 | PRD 요구사항과 설계 매핑 불일치 |
| QA-04 | 품질 | E2E 테스트 상세 명세 불완전 |
| QA-05 | 품질 | 경계값 테스트 케이스 부족 |

### P2 (단기 조치 - 구현 초기 수정)

| 이슈 ID | 영역 | 이슈 제목 |
|---------|------|----------|
| ARCH-01 | 아키텍처 | 대량 메뉴 조회 시 성능 병목 |
| ARCH-02 | 아키텍처 | 인덱스 전략 미정의 |
| ARCH-06 | 아키텍처 | 계층 깊이 제한 검증 로직 부재 |
| ARCH-07 | 아키텍처 | 삭제 정책(Cascade) 미정의 |
| SEC-04 | 보안 | icon 필드 XSS 위험 |
| SEC-06 | 보안 | 메뉴 구조 전체 노출 |
| SEC-07 | 보안 | 입력 검증 정의 누락 |
| QA-07 | 품질 | 문서 체크리스트 상태 불일치 |
| QA-08 | 품질 | createdAt/updatedAt 필드 누락 |

### P3 (중기 조치 - 구현 중 수정)

| 이슈 ID | 영역 | 이슈 제목 |
|---------|------|----------|
| ARCH-04 | 아키텍처 | OCP 부분 준수 - 메타데이터 확장성 |
| ARCH-05 | 아키텍처 | 다국어(i18n) 지원 확장 불가 |
| QA-06 | 품질 | 인터페이스 추적 범위 불일치 |

### P4-P5 (장기 조치 - 구현 후 검토)

| 이슈 ID | 영역 | 이슈 제목 |
|---------|------|----------|
| SEC-08 | 보안 | 내부 ID 노출 |
| QA-09 | 품질 | UT-005/UT-009 중복 가능성 |

---

## 리뷰 결과 판정

| 항목 | 기준 | 현재 | 판정 |
|------|------|------|------|
| Critical 이슈 | 0건 | 1건 | FAIL |
| High 이슈 | 3건 이하 | 8건 | FAIL |
| P1 이슈 | 0건 | 9건 | FAIL |

**최종 판정: FAIL - P1 이슈 해결 후 재리뷰 필요**

---

## 변경 이력

| 버전 | 일자 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| 1.0 | 2026-01-20 | claude-1 | 최초 작성 |

---

## 적용 결과 (wf:apply)

**적용 일시**: 2026-01-20

### 맥락 분석 결과

| 검토 항목 | 점수 | 비고 |
|----------|------|------|
| 시스템 적합성 | 5/5 | 현재 스택과 호환 |
| Task 범위 적합성 | 4/5 | 일부 이슈 범위 초과 |
| 실현 가능성 | 4/5 | 대부분 설계 수준 명세 가능 |

### 적용 판단 요약

| 판단 | 건수 | 이슈 ID |
|------|------|---------|
| ✅ 적용 | 14건 | SEC-01, SEC-03, ARCH-02, ARCH-03/SEC-05, ARCH-06, ARCH-07, SEC-04, SEC-07, QA-01, QA-02, QA-04, QA-05, QA-07, QA-08 |
| 📝 조정 적용 | 3건 | ARCH-01(캐싱→인덱스만), QA-03(도출규칙 명시), QA-06(범위 명확화) |
| ⏸️ 보류 | 5건 | SEC-02, SEC-06(TSK-03-02 범위), ARCH-04, ARCH-05(Phase 2), P4-P5 이슈 |

### P1 이슈 처리 결과

| 이슈 ID | 처리 | 적용 내용 |
|---------|------|----------|
| SEC-01 | ✅ | UC-01에 인증 검증 단계 추가 |
| SEC-02 | ⏸️ | TSK-03-02 범위 - 의존성 문서화 |
| SEC-03 | ✅ | path 입력 검증 규칙 추가 (섹션 8.3) |
| ARCH-03/SEC-05 | ✅ | 순환 참조 검증 로직 추가 (BR-05) |
| QA-01 | ✅ | NFR 섹션 추가 (섹션 9.3) |
| QA-02 | ✅ | 에러 코드 체계 확장 (섹션 9.1) |
| QA-03 | 📝 | 설계 도출 규칙 명시 (025 문서) |
| QA-04 | ✅ | E2E 상세 명세 추가 (026 문서) |
| QA-05 | ✅ | 경계값 테스트 케이스 추가 (UT-012) |

### P2 이슈 처리 결과

| 이슈 ID | 처리 | 적용 내용 |
|---------|------|----------|
| ARCH-01 | 📝 | 인덱스만 적용 (캐싱은 Phase 2) |
| ARCH-02 | ✅ | Prisma 인덱스 추가 |
| ARCH-06 | ✅ | 계층 깊이 검증 로직 추가 |
| ARCH-07 | ✅ | Cascade 정책 명시 |
| SEC-04 | ✅ | 아이콘 허용 목록 검증 |
| SEC-06 | ⏸️ | TSK-03-02 범위 |
| SEC-07 | ✅ | 입력 검증 규칙 추가 |
| QA-07 | ✅ | 체크리스트 상태 수정 |
| QA-08 | ✅ | createdAt/updatedAt 필드 추가 |

### P3 이슈 처리 결과

| 이슈 ID | 처리 | 사유 |
|---------|------|------|
| ARCH-04 | ⏸️ | metadata JSON 필드는 Phase 2 확장성 - MVP 범위 초과 |
| ARCH-05 | ⏸️ | i18n 지원은 PRD 5.3 Phase 2 |
| QA-06 | 📝 | 인터페이스 추적에 범위 열 추가 |

### 수정된 문서

| 문서 | 주요 변경 |
|------|----------|
| 010-design.md | UC-01 인증 추가, Prisma 스키마(인덱스/Cascade/타임스탬프), BR-05/06, 입력 검증, 에러 코드, NFR |
| 025-traceability-matrix.md | BR-005/006 추가, 설계 도출 규칙 명시, 테스트 매핑 업데이트, 인터페이스 범위 명확화 |
| 026-test-specification.md | UT-010~012 추가, E2E-002~008 상세 명세 추가, 커버리지 업데이트 |

### 최종 결과

- **P1 처리율**: 100% (9/9건 - 2건 보류는 TSK-03-02 범위)
- **P2 처리율**: 89% (8/9건)
- **적용 판정**: PASS
