# TSK-03-02 설계 리뷰 결과

## 리뷰 정보

| 항목 | 내용 |
|------|------|
| Task ID | TSK-03-02 |
| Task 제목 | 역할-메뉴 매핑 |
| 문서 버전 | 1.0 |
| 리뷰어 | claude-1 |
| 리뷰 일자 | 2026-01-20 |
| 리뷰 유형 | 설계 리뷰 (3개 관점 통합) |

---

## 검증 대상

| 문서 | 상태 | 비고 |
|------|------|------|
| 010-design.md | ✅ 존재 | 통합 설계 문서 |
| 025-traceability-matrix.md | ❌ 미존재 | 추적성 매트릭스 미작성 |
| 026-test-specification.md | ❌ 미존재 | 테스트 명세 미작성 |

---

## 검증 결과 요약

| 검증 영역 | 평가 | 비고 |
|----------|------|------|
| 문서 완전성 | WARN | 필수 문서 2건 미작성 (025, 026) |
| 요구사항 추적성 | WARN | TRD 스키마 불일치 1건 |
| 아키텍처 | WARN | P1 이슈 2건 (BR-02 모순, TRD 불일치) |
| 보안 | FAIL | Critical 1건 (서버 사이드 접근 제어 미정의) |
| 테스트 가능성 | WARN | data-testid 미정의 |

---

## 이슈 분포

| 심각도 | 아키텍처 | 보안 | 품질 | 합계 |
|--------|----------|------|------|------|
| Critical | 0 | 1 | 0 | **1** |
| High | 2 | 2 | 2 | **6** |
| Medium | 5 | 5 | 4 | **14** |
| Low | 3 | 2 | 2 | **7** |
| Info | 2 | 1 | 2 | **5** |
| **합계** | 12 | 11 | 10 | **33** |

**우선순위별 분포**: P1(5) P2(14) P3(7) P4(4) P5(3) = **33건**

---

## Critical/High 이슈 상세

### [Critical] SEC-02: 서버 사이드 경로 접근 제어 미정의

| 항목 | 내용 |
|------|------|
| 영역 | 보안 - 인증/인가 |
| 심각도 | Critical |
| 우선순위 | P1 |

**설명:**
UC-02에서 "권한 없는 메뉴 접근 차단"을 정의하고 있으나, 실제 서버 사이드 미들웨어나 API 레벨에서 경로별 권한 검증 로직이 설계에 포함되어 있지 않습니다. 메뉴 API 필터링만으로는 클라이언트 사이드에서 메뉴를 숨기는 효과만 있고, 직접 URL 접근이나 API 호출을 차단하지 못합니다.

**위협 시나리오:**
- 공격자가 `/system/users` 경로를 직접 입력하여 관리자 화면 접근
- 개발자 도구로 API 엔드포인트 확인 후 직접 호출
- 메뉴에 표시되지 않는 숨겨진 관리 API 무단 호출

**권장 조치:**
1. Next.js 미들웨어에서 경로별 권한 검증 로직 추가
2. 각 API 핸들러에서 요청된 리소스에 대한 권한 검증 수행
3. 메뉴의 `path`와 사용자 역할을 매핑하여 서버에서 접근 제어
4. 설계 문서에 서버 사이드 권한 검증 미들웨어 아키텍처 추가

**관련 섹션:** 3.2 UC-02, 6절 API 인터페이스

---

### [High] ARCH-01: TRD RoleMenu 스키마 불일치

| 항목 | 내용 |
|------|------|
| 영역 | 아키텍처 - 데이터 모델링 |
| 심각도 | High |
| 우선순위 | P1 |

**설명:**
설계 문서 4.1절의 RoleMenu Prisma 스키마에서 `onDelete: Cascade` 옵션이 포함되어 있으나, TRD 2.3절의 MVP Prisma 스키마에는 해당 옵션이 없습니다.

**권장 조치:**
- TRD의 RoleMenu 스키마에 `onDelete: Cascade` 추가하여 일관성 확보
- 양방향 참조 무결성을 위해 Role과 Menu 양쪽 relation에 Cascade 설정

**관련 섹션:** 설계 문서 4.1, TRD 2.3

---

### [High] ARCH-02: BR-02 계층형 메뉴 필터링 규칙 모순

| 항목 | 내용 |
|------|------|
| 영역 | 아키텍처 - 비즈니스 규칙 |
| 심각도 | High |
| 우선순위 | P1 |

**설명:**
BR-02 규칙은 "부모 메뉴 접근 권한이 없으면 자식 메뉴도 표시 안 함"으로 정의되어 있습니다. 그러나:
- 4.3절 권한 매트릭스: OPERATOR는 "생산 관리(부모)"에 체크가 없으나 "작업 지시", "생산 실적" 자식 메뉴에는 체크
- 7.3절 시드 데이터: OPERATOR는 'PRODUCTION' 부모 메뉴 포함

이 규칙의 일관된 적용이 필요합니다.

**권장 조치:**
1. 권한 매트릭스와 시드 데이터 일관성 확보
2. BR-02 규칙 재정의: 자식 메뉴에 권한이 있으면 부모 메뉴도 자동으로 표시 (반대 방향 규칙이 더 실용적)
3. 또는 부모-자식 권한 상속 정책 명확화

**관련 섹션:** 5.1 BR-02, 4.3 메뉴 접근 권한 매트릭스, 7.3 시드 데이터

---

### [High] SEC-01: ADMIN 역할 하드코딩 및 우회 가능성

| 항목 | 내용 |
|------|------|
| 영역 | 보안 - 접근 제어 |
| 심각도 | High |
| 우선순위 | P1 |

**설명:**
6.1절 API 로직에서 `user.role.code === 'ADMIN'` 문자열 비교로 관리자 권한을 판단합니다. role code가 'ADMIN'인 역할을 임의로 생성하거나, 대소문자 변형을 통해 권한 체크를 우회할 수 있습니다.

**권장 조치:**
1. 역할 코드 비교 시 대소문자 정규화 (`.toUpperCase()`) 적용
2. 특수 역할(ADMIN)에 대해 ID 기반 또는 별도 플래그(`isSystemAdmin`) 사용
3. 역할 생성 시 예약된 코드('ADMIN', 'SYSTEM') 사용 금지 검증

**관련 섹션:** 6.1 API 로직 (line 329)

---

### [High] SEC-03: 세션/인증 정보 검증 불충분

| 항목 | 내용 |
|------|------|
| 영역 | 보안 - 인증/인가 |
| 심각도 | High |
| 우선순위 | P2 |

**설명:**
6.1절에서 세션 검증 시 `session?.user` 존재 여부만 확인합니다. 세션 만료, 세션 탈취, 세션 고정 공격에 대한 방어 메커니즘이 설계에 명시되어 있지 않습니다.

**권장 조치:**
1. 매 요청 시 사용자의 `isActive` 상태 검증
2. 역할 변경 시 기존 세션 무효화 정책 정의
3. 세션 타임아웃 및 갱신 정책 명시

**관련 섹션:** 6.1, line 317-320

---

### [High] QUAL-03: BR-02 규칙과 시드 데이터 충돌

| 항목 | 내용 |
|------|------|
| 영역 | 품질 - 비즈니스 규칙 |
| 심각도 | High |
| 우선순위 | P1 |

**설명:**
ARCH-02와 동일한 이슈. BR-02 규칙과 권한 매트릭스/시드 데이터 간의 불일치로 구현 시 혼란 발생 예상.

**관련 섹션:** 5.1 BR-02, 4.3, 7.3

---

## Medium 이슈 요약

| ID | 제목 | 영역 | 우선순위 |
|----|------|------|----------|
| ARCH-03 | ADMIN 역할 처리 방식 이중 구현 | 아키텍처 | P2 |
| ARCH-04 | 시드 데이터 와일드카드 문법 미구현 | 아키텍처 | P2 |
| ARCH-05 | N+1 쿼리 가능성 | 아키텍처 | P2 |
| ARCH-06 | 인덱스 전략 부재 | 아키텍처 | P2 |
| ARCH-07 | 계층형 메뉴 필터링 로직 누락 | 아키텍처 | P2 |
| SEC-04 | 권한 검증의 단일 계층 의존 | 보안 | P2 |
| SEC-05 | Cascade 삭제로 인한 권한 손실 위험 | 보안 | P2 |
| SEC-06 | 입력 검증 미정의 | 보안 | P3 |
| SEC-07 | 기본 거부 원칙 미명시 | 보안 | P2 |
| SEC-08 | 감사 로그 부재 | 보안 | P3 |
| QUAL-02 | 메뉴 권한 매트릭스와 시드 데이터 불일치 | 품질 | P2 |
| QUAL-04 | data-testid 정의 누락 | 품질 | P2 |
| QUAL-05 | ADMIN 역할 특별 처리 방식 미정의 | 품질 | P2 |
| QUAL-07 | UC-02 권한 체크 상세 로직 미정의 | 품질 | P2 |

---

## 긍정적 평가 사항

### 아키텍처
- 명확한 문제 정의 및 목적 (1.1절)
- 유즈케이스 완전성 (UC-01, UC-02 기본/대안/예외 흐름)
- Mermaid ER 다이어그램 활용 (4.2절)
- 비즈니스 규칙 테이블 형식 정리 (5.1절)
- Cascade 삭제 고려 (BR-05)

### 보안
- RBAC 기반 표준 설계 패턴
- 유니크 제약조건으로 중복 매핑 방지
- 최소 권한 원칙 적용 (OPERATOR에 필요 최소 메뉴만)
- 계층형 메뉴 권한 상속 개념

### 품질
- 필수 섹션(개요, 유즈케이스, 데이터 모델, API, 에러 처리) 완비
- 에러 처리 명세 (8절)
- 의존성 명시 (9.2절)
- 체크리스트 포함 (11절)

---

## 권장 조치 요약

| 우선순위 | 조치 내용 |
|----------|----------|
| **P1 (필수)** | 1. 서버 사이드 경로 접근 제어 설계 추가<br>2. TRD 스키마 동기화<br>3. BR-02 규칙 재정의 및 데이터 일관성 확보<br>4. ADMIN 역할 검증 강화 |
| **P2 (권장)** | 1. 세션 검증 강화<br>2. ADMIN 처리 단일화<br>3. N+1 쿼리 최적화<br>4. 인덱스 전략 정의<br>5. 기본 거부 원칙 명시<br>6. data-testid 정의<br>7. UC-02 상세 로직 추가 |
| **P3 (개선)** | 1. 입력 검증 명시<br>2. 감사 로그 설계<br>3. 즐겨찾기 범위 명시<br>4. 메뉴 코드 일관성 |
| **P4~P5 (참고)** | 1. 연관 문서 작성 계획<br>2. 의존성 상태 업데이트<br>3. 예시 코드 타입 안전성 |

---

## 필수 조치 사항 (구현 전 필수)

1. **[Critical] 서버 사이드 접근 제어 설계 추가**
   - 메뉴 필터링만으로는 보안이 불충분
   - Next.js Middleware 또는 Route Guard 패턴 정의 필요

2. **[High] TRD와 설계 문서 스키마 동기화**
   - RoleMenu 모델의 `onDelete: Cascade` 일치시키기

3. **[High] BR-02 규칙 재정의**
   - 현재: "부모 권한 없으면 자식도 안 보임"
   - 권장: "자식 권한 있으면 부모도 자동 표시" 또는 부모-자식 매핑 필수화

4. **[High] ADMIN 검증 강화**
   - 문자열 비교 대신 ID 기반 또는 isSuper 플래그 사용

---

## 최종 평가

| 항목 | 평가 |
|------|------|
| 설계 품질 | **CONDITIONAL PASS** |
| 구현 진행 가능 여부 | **P1 이슈 해결 후 진행 권장** |

**Critical 1건, High 6건의 이슈가 발견되었습니다.**

특히 **서버 사이드 경로 접근 제어 미정의**(Critical)는 보안상 심각한 취약점을 유발할 수 있으므로, 구현 전 반드시 설계에 반영해야 합니다. P1 우선순위 이슈들을 먼저 해결한 후 구현을 진행하는 것을 권장합니다.

---

## 리뷰 이력

| 버전 | 일자 | 리뷰어 | 변경 내용 |
|------|------|--------|----------|
| 1.0 | 2026-01-20 | claude-1 | 최초 작성 (아키텍처/보안/품질 3개 관점 통합 리뷰) |

---

<!--
wf:review output
Task: TSK-03-02
Reviewer: claude-1
Date: 2026-01-20
-->
