# RBAC 재설계 - 기본 설계서

> 화면 와이어프레임 및 핵심 코드 스니펫을 포함하는 상세 설계 문서
> - PRD: `.orchay/projects/rbac-redesign/prd.md`
> - TRD: `.orchay/projects/rbac-redesign/trd.md`

---

## 1. 화면 상세 설계

### 1.1 권한 통합 관리 화면 (`/system/authority`)

> 사용자 기준 3단 마스터-디테일: 상단 = 보유 목록, 하단 = 전체 목록(체크박스)
> 한 화면에서 조회 + 등록(할당) + 해제 + 생성 + 수정 모두 가능

#### 전체 레이아웃

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│ 권한 통합 관리                     사용자: [김철수 ▼]    시스템: [공장1 MES ▼]       │
├─────────────────────┬──────────────────────┬────────────────────────────────────────┤
│ ① 역할그룹          │ ② 역할               │ ③ 권한                                │
│ ─── 보유 중 ─────── │ ─── 보유 중 ──────── │ ─── 보유 중 ────────────────────────── │
│ [검색________________]│[검색________________]│[검색________________]                  │
│ ┌─────────────────┐ │ ┌──────────────────┐ │ ┌──────────────────────────────────┐   │
│ │● 관리자 그룹    │ │ │● ADMIN           │ │ │ ▼ 시스템관리                      │   │
│ │  admin-group    │ │ │  시스템 관리자    │ │ │   사용자관리                      │   │
│ │  역할 3개       │ │ │  Lv.0 · 시스템   │ │ │    user-mgmt-admin  C,R,U,D,E   │   │
│ │                 │ │ │                  │ │ │   역할관리                        │   │
│ │○ 생산팀 그룹    │ │ │○ SECURITY_ADMIN  │ │ │    role-mgmt-admin  C,R,U,D     │   │
│ │  prod-group     │ │ │  보안 관리자     │ │ │ ▼ 조업관리                        │   │
│ │  역할 2개       │ │ │  Lv.1            │ │ │   생산현황                        │   │
│ │                 │ │ │                  │ │ │    prod-status-admin C,R,U,D,E  │   │
│ │                 │ │ │○ USER_MANAGER    │ │ │                                  │   │
│ │                 │ │ │  사용자 관리자   │ │ │ 선택: prod-status-admin           │   │
│ │                 │ │ │  Lv.2            │ │ │ Actions: C,R,U,D,E  제약: 없음   │   │
│ │                 │ │ │                  │ │ │ [해제]                            │   │
│ └─────────────────┘ │ └──────────────────┘ │ └──────────────────────────────────┘   │
│ [해제]              │ [해제]               │                                        │
│                     │                      │                                        │
│ ─── 전체 ────────── │ ─── 전체 ──────────  │ ─── 전체 ──────────────────────────── │
│ (✓=보유 / □=미보유)  │ (✓=보유 / □=미보유)  │ (✓=보유 / □=미보유)                    │
│ [검색________________]│[검색________________]│[검색________________]                  │
│ [상태 ▼] [보유 ▼]   │ [레벨 ▼] [보유 ▼]   │ [화면 ▼] [Actions ▼] [보유 ▼]         │
│ ┌─────────────────┐ │ ┌──────────────────┐ │ ┌──────────────────────────────────┐   │
│ │ ✓ 관리자 그룹   │ │ │ ✓ ADMIN          │ │ │ ▼ 시스템관리                      │   │
│ │   admin-group   │ │ │   시스템 관리자   │ │ │   사용자관리                      │   │
│ │ ✓ 생산팀 그룹   │ │ │ ✓ SECURITY_ADMIN │ │ │    ✓ user-mgmt-admin  C,R,U,D,E │   │
│ │   prod-group    │ │ │   보안 관리자    │ │ │    □ user-mgmt-viewer  R         │   │
│ │ □ 품질팀 그룹   │ │ │ ✓ USER_MANAGER   │ │ │   역할관리                        │   │
│ │   quality-group │ │ │   사용자 관리자   │ │ │    ✓ role-mgmt-admin  C,R,U,D   │   │
│ │ □ 설비팀 그룹   │ │ │ □ PROD_MANAGER   │ │ │ ▼ 조업관리                        │   │
│ │   equip-group   │ │ │   생산 관리자    │ │ │   생산현황                        │   │
│ │ □ 외주팀 그룹   │ │ │ □ QUALITY_MGR    │ │ │    ✓ prod-status-admin C,R,U,D,E│   │
│ │   outsrc-group  │ │ │   품질 관리자    │ │ │    □ prod-status-2cgl  R PROC:2C│   │
│ │                 │ │ │ □ VIEWER         │ │ │   실적등록                        │   │
│ │                 │ │ │   조회자         │ │ │    □ result-entry-admin C,R,U    │   │
│ └─────────────────┘ │ └──────────────────┘ │ └──────────────────────────────────┘   │
│ [등록] [생성] [수정] │ [등록] [생성] [수정] │ [등록] [생성] [수정]                   │
└─────────────────────┴──────────────────────┴────────────────────────────────────────┘
```

#### 필터 상세

| 컬럼 | 필터 항목 | 설명 |
|------|----------|------|
| ① 역할그룹 (보유) | 검색 | 이름/코드 텍스트 검색 |
| ① 역할그룹 (전체) | 검색, 상태, 보유 | 텍스트 검색 + 활성/비활성 + 보유/미보유/전체 |
| ② 역할 (보유) | 검색 | 이름/코드 텍스트 검색 |
| ② 역할 (전체) | 검색, 레벨, 보유 | 텍스트 검색 + 역할 레벨(0~3) + 보유/미보유/전체 |
| ③ 권한 (보유) | 검색 | 이름/코드 텍스트 검색 |
| ③ 권한 (전체) | 검색, 화면, Actions, 보유 | 텍스트 검색 + 메뉴 선택 + Action 필터 + 보유/미보유/전체 |

> **공통 필터 동작**:
> - **보유 필터**: `전체`(기본) / `보유만(✓)` / `미보유만(□)` — 전체 목록에서 할당 상태로 필터링
> - **검색**: 이름 또는 코드에 대한 부분 일치 (클라이언트 사이드 필터링)
> - 필터 초기값: 모두 `전체`, 상위 컬럼 선택 변경 시 하위 필터 초기화

#### 인터랙션 흐름

```
사용자 선택 → ① 보유 역할그룹 로드 + 전체 역할그룹 로드
① 역할그룹 선택 → ② 보유 역할 로드 (해당 그룹) + 전체 역할 로드
② 역할 선택     → ③ 보유 권한 로드 (해당 역할) + 전체 권한 로드
```

#### ① 역할그룹 컬럼

**보유 중 (상단)**
```
┌─────────────────────────┐
│ 보유 역할그룹     [검색] │
├─────────────────────────┤
│ ● 관리자 그룹           │ ← 선택 중 → ② 로드
│   admin-group · 역할 3개│
│─────────────────────────│
│ ○ 생산팀 그룹           │
│   prod-group · 역할 2개 │
└─────────────────────────┘
│ [해제] ← 선택된 역할그룹을 사용자에게서 해제
│         (UserRoleGroup DELETE + History REVOKE)
```

**전체 (하단)** — ✓=보유, □=미보유
```
┌─────────────────────────┐
│ 전체 역할그룹     [검색] │
├─────────────────────────┤
│ ✓ 관리자 그룹           │
│   admin-group           │
│─────────────────────────│
│ ✓ 생산팀 그룹           │
│   prod-group            │
│─────────────────────────│
│ □ 품질팀 그룹           │
│   quality-group         │
│─────────────────────────│
│ □ 설비팀 그룹           │
│   equip-group           │
│─────────────────────────│
│ □ 외주팀 그룹           │
│   outsrc-group          │
└─────────────────────────┘
│ [등록] ← □→✓ 체크한 미보유 항목을 사용자에게 할당
│         ✓→□ 체크 해제한 보유 항목은 해제
│         → 등록 확인 모달 표시
│
│ [생성] ← 새 역할그룹 생성 모달
│ [수정] ← 선택된 역할그룹 수정 모달
```

**역할그룹 생성/수정 모달**
```
┌──────────────────────────────┐
│ 역할그룹 생성 (또는 수정) [X] │
├──────────────────────────────┤
│ 코드 *  [________________]   │  ← 수정 시 읽기전용
│ 이름 *  [________________]   │
│ 설명    [________________]   │
│ 활성화  [✓]                  │
├──────────────────────────────┤
│           [취소]  [저장]     │
└──────────────────────────────┘
```

#### ② 역할 컬럼

**보유 중 (상단)** — 선택된 역할그룹에 속한 역할
```
┌─────────────────────────────┐
│ 보유 역할 (관리자 그룹) [검색]│
├─────────────────────────────┤
│ ● ADMIN                    │ ← 선택 중 → ③ 로드
│   시스템 관리자 · Lv.0     │
│─────────────────────────────│
│ ○ SECURITY_ADMIN            │
│   보안 관리자 · Lv.1       │
│─────────────────────────────│
│ ○ USER_MANAGER              │
│   사용자 관리자 · Lv.2     │
└─────────────────────────────┘
│ [해제] ← 선택된 역할을 역할그룹에서 해제
```

**전체 (하단)** — ✓=보유, □=미보유
```
┌─────────────────────────────┐
│ 전체 역할            [검색]  │
├─────────────────────────────┤
│ ✓ ADMIN                     │
│   시스템 관리자 · Lv.0      │
│ ✓ SECURITY_ADMIN             │
│   보안 관리자 · Lv.1        │
│ ✓ USER_MANAGER               │
│   사용자 관리자 · Lv.2      │
│ □ PROD_MANAGER               │
│   생산 관리자 · Lv.1        │
│ □ QUALITY_MGR                │
│   품질 관리자 · Lv.1        │
│ □ VIEWER                     │
│   조회자 · Lv.3             │
└─────────────────────────────┘
│ [등록] [생성] [수정]
```

**역할 생성/수정 모달**
```
┌──────────────────────────────┐
│ 역할 생성 (또는 수정)   [X]  │
├──────────────────────────────┤
│ 코드 *     [________________]│
│ 이름 *     [________________]│
│ 상위 역할  [없음 ▼         ] │
│ 레벨       [0              ] │
│ 설명       [________________]│
│ 시스템역할 [ ]               │
│ 활성화     [✓]               │
├──────────────────────────────┤
│           [취소]  [저장]     │
└──────────────────────────────┘
```

#### ③ 권한 컬럼

**보유 중 (상단)** — 선택된 역할에 할당된 권한
```
┌──────────────────────────────────────────────────┐
│ 보유 권한 (ADMIN)                         [검색]  │
├──────────────────────────────────────────────────┤
│ ▼ 시스템관리                                     │
│   사용자관리                                     │
│    ● user-mgmt-admin   C,R,U,D,E   제약:없음   │
│   역할관리                                       │
│    ○ role-mgmt-admin   C,R,U,D     제약:없음   │
│ ▼ 조업관리                                       │
│   생산현황                                       │
│    ○ prod-status-admin C,R,U,D,E   제약:없음   │
├──────────────────────────────────────────────────┤
│ 선택: user-mgmt-admin                            │
│ 이름: 사용자관리 관리자                           │
│ 화면: 시스템관리 > 사용자관리                     │
│ Actions: CREATE, READ, UPDATE, DELETE, EXPORT    │
│ Field Constraints: 없음 (전체)                   │
│ [해제]                                           │
└──────────────────────────────────────────────────┘
```

**전체 (하단)** — ✓=보유, □=미보유 (메뉴 트리로 표시)
```
┌──────────────────────────────────────────────────┐
│ 전체 권한                                  [검색] │
├──────────────────────────────────────────────────┤
│ ▼ 시스템관리                                     │
│   사용자관리                                     │
│    ✓ user-mgmt-admin    C,R,U,D,E   제약:없음  │
│    □ user-mgmt-viewer   R            제약:없음  │
│   역할관리                                       │
│    ✓ role-mgmt-admin    C,R,U,D      제약:없음  │
│ ▼ 조업관리                                       │
│   생산현황                                       │
│    ✓ prod-status-admin  C,R,U,D,E   제약:없음  │
│    □ prod-status-2cgl   R          PROC:2CGL   │
│    □ prod-status-2-3cgl R,E     PROC:2,3CGL   │
│   실적등록                                       │
│    □ result-entry-admin C,R,U      제약:없음   │
│   품질검사                                       │
│    □ quality-inspect    R,U        제약:없음   │
├──────────────────────────────────────────────────┤
│ [등록] [생성] [수정]                              │
└──────────────────────────────────────────────────┘
```

**권한 생성/수정 모달**
```
┌──────────────────────────────────────────────┐
│ 권한 생성 (또는 수정)                   [X]  │
├──────────────────────────────────────────────┤
│ 코드 *       [________________]              │
│ 이름 *       [________________]              │
│ 화면 *       [사용자관리 ▼     ]             │
│ 설명         [________________]              │
│ 활성화       [✓]                             │
│                                              │
│ ─── Actions ───────────────────────────      │
│ ☑ CREATE  ☑ READ  ☑ UPDATE                   │
│ ☑ DELETE  ☑ EXPORT  □ IMPORT                  │
│                                              │
│ ─── Field Constraints ─────────────────      │
│ ┌──────────────────────────────────────┐     │
│ │ 필드명       │ 제약 값         │ 삭제│     │
│ │ PROC_CD      │ [2CGL, 3CGL   ] │ [X] │     │
│ └──────────────────────────────────────┘     │
│ [+ 필드 제약 추가]                            │
│                                              │
├──────────────────────────────────────────────┤
│                [취소]  [저장]                 │
└──────────────────────────────────────────────┘
```

**등록 확인 모달** (모든 컬럼 공통)
```
┌──────────────────────────────────────┐
│ 변경 사항 확인                  [X]  │
├──────────────────────────────────────┤
│ 추가 할당:                           │
│  + 품질팀 그룹 (quality-group)       │
│  + 외주팀 그룹 (outsrc-group)        │
│                                      │
│ 해제:                                │
│  - 생산팀 그룹 (prod-group)          │
│                                      │
├──────────────────────────────────────┤
│           [취소]  [확인]             │
└──────────────────────────────────────┘
```

#### 데이터 흐름 요약

| 동작 | 대상 테이블 | History |
|------|------------|---------|
| ① [등록] □→✓ | UserRoleGroup INSERT | UserRoleGroupHistory (ASSIGN) |
| ① [등록] ✓→□ | UserRoleGroup DELETE | UserRoleGroupHistory (REVOKE) |
| ① 보유 → [해제] | UserRoleGroup DELETE | UserRoleGroupHistory (REVOKE) |
| ① [생성] | RoleGroup INSERT | RoleGroupHistory (CREATE) |
| ① [수정] | RoleGroup UPDATE | RoleGroupHistory (UPDATE) |
| ② [등록] □→✓ | RoleGroupRole INSERT | RoleGroupRoleHistory (ASSIGN) |
| ② [등록] ✓→□ | RoleGroupRole DELETE | RoleGroupRoleHistory (REVOKE) |
| ② 보유 → [해제] | RoleGroupRole DELETE | RoleGroupRoleHistory (REVOKE) |
| ② [생성] | Role INSERT | RoleHistory (CREATE) |
| ② [수정] | Role UPDATE | RoleHistory (UPDATE) |
| ③ [등록] □→✓ | RolePermission INSERT | RolePermissionHistory (ASSIGN) |
| ③ [등록] ✓→□ | RolePermission DELETE | RolePermissionHistory (REVOKE) |
| ③ 보유 → [해제] | RolePermission DELETE | RolePermissionHistory (REVOKE) |
| ③ [생성] | Permission INSERT | PermissionHistory (CREATE) |
| ③ [수정] | Permission UPDATE | PermissionHistory (UPDATE) |

#### 반응형 동작
- **사용자 변경 시**: ① 전체 갱신 (보유 + 전체 목록), ②③ 초기화
- **① 역할그룹 선택 시**: ② 보유 + 전체 갱신, ③ 초기화
- **② 역할 선택 시**: ③ 보유 + 전체 갱신
- **[등록] 후**: 해당 컬럼 + 하위 컬럼 자동 갱신
- **[생성]/[수정] 후**: 해당 컬럼의 전체 목록 갱신

---

### 1.2 권한 정의 관리 화면 (`/system/permissions`)

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 권한 관리                                                    [+ 생성]   │
├─────────────────────────────────────────────────────────────────────────┤
│ 필터: [화면 선택 ▼] [상태 ▼] [검색어___________] [검색]                 │
├─────────────────────────────────────────────────────────────────────────┤
│ ┌───────────────────────────┬───────────────────────────────────────┐   │
│ │ 메뉴 트리 (category 기반) │ 선택된 권한 상세                       │   │
│ │ ▼ 시스템관리              │ ┌─────────────────────────────────┐   │   │
│ │   ▼ 사용자관리            │ │ 코드: user-mgmt-admin           │   │   │
│ │     ● user-mgmt-admin     │ │ 이름: 사용자관리 관리자          │   │   │
│ │     ○ user-mgmt-viewer    │ │ 화면: 사용자관리                 │   │   │
│ │   ▼ 역할관리              │ │                                  │   │   │
│ │     ○ role-mgmt-admin     │ │ Actions:                         │   │   │
│ │ ▼ 조업관리                │ │   ✓ CREATE  ✓ READ              │   │   │
│ │   ▼ 생산실적              │ │   ✓ UPDATE  ✓ DELETE             │   │   │
│ │     ○ prod-status-admin   │ │   ✓ EXPORT  □ IMPORT            │   │   │
│ │     ○ prod-status-2cgl    │ │                                  │   │   │
│ │     ○ prod-status-2-3cgl  │ │ Field Constraints:               │   │   │
│ │                           │ │   (없음 - 전체 접근)              │   │   │
│ │                           │ │                                  │   │   │
│ │                           │ │ 할당된 역할:                      │   │   │
│ │                           │ │   - ADMIN (관리자)               │   │   │
│ │                           │ │   - MANAGER (매니저)             │   │   │
│ │                           │ │                                  │   │   │
│ │                           │ │ [수정] [삭제]                    │   │   │
│ │                           │ └─────────────────────────────────┘   │   │
│ └───────────────────────────┴───────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### 1.3 역할 관리 화면 개선 (`/system/roles`)

#### 역할-권한 할당 탭
```
┌───────────────────────────────────────────────────────────────────────────┐
│ 역할 상세: ADMIN (관리자)                                                 │
├───────────────────────────────────────────────────────────────────────────┤
│ [기본 정보] [권한 할당] [할당된 사용자]                                     │
├───────────────────────────────────────────────────────────────────────────┤
│ 권한 할당                                                  [변경 저장]     │
│ ┌─────────────────────────────────────────────────────────────────────┐   │
│ │ 화면            │ 권한명                │ Actions       │ 제약 │ 할당│   │
│ ├─────────────────────────────────────────────────────────────────────┤   │
│ │ ▼ 시스템관리                                                        │   │
│ │   사용자관리    │ user-mgmt-admin       │ C,R,U,D,E     │ -    │ ✓  │   │
│ │                 │ user-mgmt-viewer      │ R             │ -    │ □  │   │
│ │   역할관리      │ role-mgmt-admin       │ C,R,U,D       │ -    │ ✓  │   │
│ │ ▼ 조업관리                                                          │   │
│ │   생산현황      │ prod-status-admin     │ C,R,U,D,E     │ -    │ ✓  │   │
│ │                 │ prod-status-2cgl      │ R             │ PROC │ □  │   │
│ │                 │ prod-status-2-3cgl    │ R,E           │ PROC │ □  │   │
│ └─────────────────────────────────────────────────────────────────────┘   │
│                                                                           │
│ ✓ = 할당됨  □ = 미할당  C=CREATE R=READ U=UPDATE D=DELETE E=EXPORT        │
│ 제약 컬럼: fieldConstraints 유무 (hover 시 상세 표시)                      │
└───────────────────────────────────────────────────────────────────────────┘
```

---

### 1.4 사용자 관리 화면 개선 (`/system/users`)

#### 사용자 상세 - 역할그룹 할당
```
┌─────────────────────────────────────────────────────────────────────┐
│ 사용자 상세: 홍길동 (hong@example.com)                               │
├─────────────────────────────────────────────────────────────────────┤
│ [기본 정보] [역할그룹] [시스템 접근] [활동 로그]                      │
├─────────────────────────────────────────────────────────────────────┤
│ 역할그룹 할당                                          [+ 할당]      │
│ ┌───────────────────────────────────────────────────────────────┐   │
│ │ 역할그룹        │ 포함 역할              │ 할당일    │ 작업   │   │
│ ├───────────────────────────────────────────────────────────────┤   │
│ │ 관리자 그룹     │ ADMIN, SECURITY_ADMIN  │ 2026-01-15│ [해제] │   │
│ │ 생산팀 그룹     │ PRODUCTION_MANAGER     │ 2026-01-20│ [해제] │   │
│ └───────────────────────────────────────────────────────────────┘   │
│                                                                      │
│ 최종 권한 (계산된 결과)                                [펼치기 ▼]    │
│ ┌───────────────────────────────────────────────────────────────┐   │
│ │ 사용자 관리: read, create, update, delete                     │   │
│ │ 역할 관리: read, create, update, delete                       │   │
│ │ 생산 현황: read, export                                       │   │
│ │ 작업 지시: read, create, update                               │   │
│ └───────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 1.5 시스템(테넌트) 관리 화면 (`/system/systems`)

```
┌─────────────────────────────────────────────────────────────────────┐
│ 시스템 관리                                              [+ 생성]    │
├─────────────────────────────────────────────────────────────────────┤
│ ┌───────────────────────────────────────────────────────────────┐   │
│ │ 코드          │ 이름        │ 도메인              │ 상태│작업│   │
│ ├───────────────────────────────────────────────────────────────┤   │
│ │ mes-factory1  │ 공장1 MES   │ factory1.mes.com    │ ✓  │ 편집│   │
│ │ mes-factory2  │ 공장2 MES   │ factory2.mes.com    │ ✓  │ 편집│   │
│ │ mes-hq        │ 본사 MES    │ hq.mes.com          │ ✓  │ 편집│   │
│ └───────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 1.6 역할그룹 관리 화면 (`/system/role-groups`)

```
┌─────────────────────────────────────────────────────────────────────┐
│ 역할그룹 관리                                            [+ 생성]    │
├─────────────────────────────────────────────────────────────────────┤
│ 필터: [시스템 선택 ▼] [상태 ▼]                                      │
├─────────────────────────────────────────────────────────────────────┤
│ ┌───────────────────────────────────────────────────────────────┐   │
│ │ 코드         │ 이름       │ 시스템    │ 포함 역할   │상태│작업│   │
│ ├───────────────────────────────────────────────────────────────┤   │
│ │ admin-group  │ 관리자그룹 │ 공장1 MES │ ADMIN, SEC..│ ✓ │ 편집│   │
│ │ prod-group   │ 생산팀그룹 │ 공장1 MES │ PROD_MGR   │ ✓ │ 편집│   │
│ │ viewer-group │ 조회자그룹 │ 공장1 MES │ VIEWER     │ ✓ │ 편집│   │
│ └───────────────────────────────────────────────────────────────┘   │
│                                                                      │
│ [역할그룹 상세] (admin-group 선택 시)                                │
│ ┌───────────────────────────────────────────────────────────────┐   │
│ │ 포함된 역할:                                      [+ 역할 추가] │   │
│ │ ┌─────────────────────────────────────────────────────────┐   │   │
│ │ │ ADMIN (시스템 관리자)                            [제거] │   │   │
│ │ │ SECURITY_ADMIN (보안 관리자)                     [제거] │   │   │
│ │ └─────────────────────────────────────────────────────────┘   │   │
│ │                                                               │   │
│ │ 할당된 사용자: 3명                                 [상세보기] │   │
│ └───────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. 핵심 코드 스니펫

### 2.1 Menu Category 트리 구축 알고리즘

```typescript
// 1. DB에서 sortOrder로 정렬하여 조회
const menus = await prisma.menu.findMany({ orderBy: { sortOrder: 'asc' } })

// 2. 순서대로 처리하며 트리 구축
interface TreeNode {
  name: string
  isFolder: boolean
  path?: string
  children: TreeNode[]
}

function buildMenuTree(menus: Menu[]): TreeNode[] {
  const root: TreeNode[] = []

  for (const menu of menus) {
    const categories = menu.category.split('/')  // ["조업관리", "생산실적"]
    let current = root

    // category 경로를 따라가며 폴더 생성/탐색
    for (const category of categories) {
      let folder = current.find(n => n.name === category && n.isFolder)
      if (!folder) {
        folder = { name: category, isFolder: true, children: [] }
        current.push(folder)  // 없으면 자동 생성
      }
      current = folder.children
    }

    // 최종 위치에 메뉴 추가
    current.push({ name: menu.name, path: menu.path, isFolder: false, children: [] })
  }

  return root
}
```

**결과 트리:**
```
├─ 조업관리 (자동생성)
│  ├─ 생산실적 (자동생성)
│  │  ├─ 검사실적조회
│  │  └─ 실적등록
│  └─ 품질관리 (자동생성)
│     └─ 품질검사
└─ 시스템관리 (자동생성)
   └─ 사용자관리
```

**중간 삽입 예시:**
```
기존: "100", "200", "300"
삽입: "150" → 검사실적조회와 실적등록 사이에 새 메뉴 추가
```

---

### 2.2 Permission 병합 로직

```typescript
interface MergedPermission {
  menuId: number
  actions: Set<string>
  fieldConstraints: Record<string, Set<string> | null>  // null = 전체(제약 없음)
}

function mergePermissions(permissions: PermissionConfig[]): MergedPermission {
  const merged: MergedPermission = {
    menuId: permissions[0].menuId,
    actions: new Set(),
    fieldConstraints: {}
  }

  for (const perm of permissions) {
    // actions 합집합
    perm.config.actions.forEach(a => merged.actions.add(a))

    // fieldConstraints 병합
    if (!perm.config.fieldConstraints) {
      // 제약 없는 Permission이 하나라도 있으면 → 전체 해제
      for (const key of Object.keys(merged.fieldConstraints)) {
        merged.fieldConstraints[key] = null
      }
      merged.fieldConstraints["__all__"] = null  // 전체 해제 마커
      continue
    }

    if (merged.fieldConstraints["__all__"] === null) {
      continue  // 이미 전체 해제
    }

    for (const [field, value] of Object.entries(perm.config.fieldConstraints)) {
      if (merged.fieldConstraints[field] === null) {
        continue  // 이 필드는 이미 전체 해제
      }

      const values = Array.isArray(value) ? value : [value]
      if (!merged.fieldConstraints[field]) {
        merged.fieldConstraints[field] = new Set(values)
      } else {
        values.forEach(v => (merged.fieldConstraints[field] as Set<string>).add(v))
      }
    }
  }

  // __all__ 마커가 있으면 전체 fieldConstraints 제거
  if (merged.fieldConstraints["__all__"] === null) {
    merged.fieldConstraints = {}
  }

  return merged
}
```

#### 병합 규칙 요약

| 항목 | 규칙 | 예시 |
|------|------|------|
| actions | 합집합 | `[R] ∪ [R,E]` = `[R,E]` |
| fieldConstraints 같은 필드 | 값 합집합 | `"2CGL" ∪ ["2CGL","3CGL"]` = `["2CGL","3CGL"]` |
| fieldConstraints 한쪽 없음 | 제약 해제 (전체) | `제약없음 ∪ PROC:2CGL` = `전체` |
| fieldConstraints 다른 필드 | 각각 유지 | `{PROC:2CGL} ∪ {LINE:1LINE}` = `{PROC:2CGL, LINE:1LINE}` |

---

### 2.3 이력 기록 로직

```typescript
// lib/auth/history.ts

/**
 * 마스터 테이블 변경 시 이력 기록
 * - CREATE: 새 선분 생성 (validTo = null)
 * - UPDATE: 기존 선분 닫기 (validTo = now) + 새 선분 생성
 * - DELETE: 기존 선분 닫기 (validTo = now)
 */
export async function writePermissionHistory(
  data: Permission,
  changeType: "CREATE" | "UPDATE" | "DELETE",
  changedBy: number
) {
  const now = new Date()

  if (changeType === "UPDATE" || changeType === "DELETE") {
    // 기존 열린 선분 닫기
    await prisma.permissionHistory.updateMany({
      where: { permissionId: data.permissionId, validTo: null },
      data: { validTo: now }
    })
  }

  if (changeType !== "DELETE") {
    // 새 선분 생성
    await prisma.permissionHistory.create({
      data: {
        permissionId: data.permissionId,
        systemId: data.systemId,
        menuId: data.menuId,
        permissionCd: data.permissionCd,
        name: data.name,
        config: data.config,
        description: data.description,
        isActive: data.isActive,
        validFrom: now,
        validTo: null,
        changeType,
        changedBy
      }
    })
  }
}

/**
 * 매핑 테이블 변경 시 이력 기록
 * - ASSIGN: 새 선분 생성 (validTo = null)
 * - REVOKE: 기존 선분 닫기 (validTo = now)
 */
export async function writeRolePermissionHistory(
  roleId: number,
  permissionId: number,
  changeType: "ASSIGN" | "REVOKE",
  changedBy: number
) {
  const now = new Date()

  if (changeType === "REVOKE") {
    await prisma.rolePermissionHistory.updateMany({
      where: { roleId, permissionId, validTo: null },
      data: { validTo: now }
    })
  }

  if (changeType === "ASSIGN") {
    await prisma.rolePermissionHistory.create({
      data: { roleId, permissionId, validFrom: now, validTo: null, changeType, changedBy }
    })
  }
}
```

---

### 2.4 특정 시점 권한 조회

```typescript
/**
 * 특정 시점의 사용자 권한 조회
 * "2026년 1월 15일에 이 사용자의 권한이 뭐였지?"
 */
export async function getPermissionsAt(userId: string, asOf: Date) {
  // 1. 해당 시점에 유효한 UserRoleGroup
  const roleGroups = await prisma.userRoleGroupHistory.findMany({
    where: {
      userId,
      validFrom: { lte: asOf },
      OR: [{ validTo: null }, { validTo: { gt: asOf } }]
    }
  })

  // 2. 해당 시점에 유효한 RoleGroupRole
  const roleGroupIds = roleGroups.map(rg => rg.roleGroupId)
  const roles = await prisma.roleGroupRoleHistory.findMany({
    where: {
      roleGroupId: { in: roleGroupIds },
      validFrom: { lte: asOf },
      OR: [{ validTo: null }, { validTo: { gt: asOf } }]
    }
  })

  // 3. 해당 시점에 유효한 RolePermission
  const roleIds = roles.map(r => r.roleId)
  const rolePerms = await prisma.rolePermissionHistory.findMany({
    where: {
      roleId: { in: roleIds },
      validFrom: { lte: asOf },
      OR: [{ validTo: null }, { validTo: { gt: asOf } }]
    }
  })

  // 4. 해당 시점의 Permission 스냅샷
  const permIds = rolePerms.map(rp => rp.permissionId)
  const permissions = await prisma.permissionHistory.findMany({
    where: {
      permissionId: { in: permIds },
      validFrom: { lte: asOf },
      OR: [{ validTo: null }, { validTo: { gt: asOf } }]
    }
  })

  return permissions
}
```

---

## 3. 변경 이력

| 버전 | 작성일 | 작성자 | 변경 내용 |
|------|--------|--------|----------|
| 1.0 | 2026-01-27 | Claude | RBAC-REDESIGN-PLAN.md에서 기본 설계서 분리 |
