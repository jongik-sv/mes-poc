// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

// ============================================
// USER SECTION
// ============================================

model System {
  systemId    String    @id @map("id") // "mes-factory1"
  name        String
  domain      String    @unique
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  menuSets    MenuSet[]
  roleGroups  RoleGroup[]
  menus       Menu[]
  roles       Role[]
  permissions Permission[]

  @@map("systems")
}

model User {
  userId              String    @id @map("id") // 사번: "41000132"
  email               String    @unique
  password            String
  name                String
  phone               String?
  department          String?
  isActive            Boolean   @default(true)
  isLocked            Boolean   @default(false)
  lockUntil           DateTime?
  failedLoginAttempts Int       @default(0)
  passwordChangedAt   DateTime  @default(now())
  mustChangePassword  Boolean   @default(true)
  lastLoginAt         DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  userRoleGroups      UserRoleGroup[]
  userSystemMenuSets  UserSystemMenuSet[]
  sessions            Session[]
  refreshTokens       RefreshToken[]
  auditLogs           AuditLog[]
  passwordHistory     PasswordHistory[]
  passwordResetTokens PasswordResetToken[]

  @@index([email])
  @@index([isActive])
  @@index([isLocked])
  @@map("users")
}

model UserSystemMenuSet {
  userId    String
  systemId  String
  menuSetId Int
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [userId], onDelete: Cascade)
  menuSet MenuSet @relation(fields: [menuSetId], references: [menuSetId], onDelete: Cascade)

  @@id([userId, systemId])
  @@index([userId])
  @@index([menuSetId])
  @@map("user_system_menu_sets")
}

model UserRoleGroup {
  userId      String
  roleGroupId Int
  assignedAt  DateTime @default(now())
  assignedBy  String?  // 할당한 사용자 ID

  user      User      @relation(fields: [userId], references: [userId], onDelete: Cascade)
  roleGroup RoleGroup @relation(fields: [roleGroupId], references: [roleGroupId], onDelete: Cascade)

  @@id([userId, roleGroupId])
  @@index([userId])
  @@index([roleGroupId])
  @@map("user_role_groups")
}

// ============================================
// MENU SECTION
// ============================================

model MenuSet {
  menuSetId   Int      @id @default(autoincrement()) @map("id")
  systemId    String
  menuSetCd   String   @unique @map("menu_set_cd")
  name        String
  description String?
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  system             System              @relation(fields: [systemId], references: [systemId])
  menuSetMenus       MenuSetMenu[]
  userSystemMenuSets UserSystemMenuSet[]

  @@index([systemId])
  @@index([isActive])
  @@map("menu_sets")
}

model MenuSetMenu {
  menuSetId Int
  menuId    Int
  createdAt DateTime @default(now())

  menuSet MenuSet @relation(fields: [menuSetId], references: [menuSetId], onDelete: Cascade)
  menu    Menu    @relation(fields: [menuId], references: [menuId], onDelete: Cascade)

  @@id([menuSetId, menuId])
  @@index([menuSetId])
  @@index([menuId])
  @@map("menu_set_menus")
}

model Menu {
  menuId    Int      @id @default(autoincrement()) @map("id")
  systemId  String
  menuCd    String   @unique @map("menu_cd")
  name      String
  category  String   // "조업관리/생산실적" - path 기반 트리 구축
  path      String?
  icon      String?
  sortOrder String   @default("100") // varchar 정렬 (중간 삽입 용이)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  system       System        @relation(fields: [systemId], references: [systemId])
  permissions  Permission[]
  menuSetMenus MenuSetMenu[]

  @@index([systemId])
  @@index([category])
  @@index([sortOrder])
  @@index([isActive])
  @@map("menus")
}

// ============================================
// PERMISSION / ROLE SECTION
// ============================================

model RoleGroup {
  roleGroupId Int      @id @default(autoincrement()) @map("id")
  systemId    String
  roleGroupCd String   @unique @map("role_group_cd")
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  system         System          @relation(fields: [systemId], references: [systemId])
  roleGroupRoles RoleGroupRole[]
  userRoleGroups UserRoleGroup[]

  @@index([systemId])
  @@index([isActive])
  @@map("role_groups")
}

model RoleGroupRole {
  roleGroupId Int
  roleId      Int
  createdAt   DateTime @default(now())

  roleGroup RoleGroup @relation(fields: [roleGroupId], references: [roleGroupId], onDelete: Cascade)
  role      Role      @relation(fields: [roleId], references: [roleId], onDelete: Cascade)

  @@id([roleGroupId, roleId])
  @@index([roleGroupId])
  @@index([roleId])
  @@map("role_group_roles")
}

model Role {
  roleId       Int      @id @default(autoincrement()) @map("id")
  systemId     String
  parentRoleId Int?     @map("parent_id")
  roleCd       String   @unique @map("role_cd")
  name         String
  description  String?
  level        Int      @default(0)
  isSystem     Boolean  @default(false)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  system          System           @relation(fields: [systemId], references: [systemId])
  parent          Role?            @relation("RoleHierarchy", fields: [parentRoleId], references: [roleId])
  children        Role[]           @relation("RoleHierarchy")
  roleGroupRoles  RoleGroupRole[]
  rolePermissions RolePermission[]

  @@index([systemId])
  @@index([parentRoleId])
  @@index([isActive])
  @@map("roles")
}

model RolePermission {
  roleId       Int
  permissionId Int
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [roleId], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [permissionId], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model Permission {
  permissionId Int      @id @default(autoincrement()) @map("id")
  systemId     String
  menuId       Int?
  permissionCd String   @unique @map("permission_cd")
  name         String
  config       String   // JSON: { actions: string[], fieldConstraints?: Record<string, string | string[]> }
  description  String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  system          System           @relation(fields: [systemId], references: [systemId])
  menu            Menu?            @relation(fields: [menuId], references: [menuId])
  rolePermissions RolePermission[]

  @@index([systemId])
  @@index([menuId])
  @@index([isActive])
  @@map("permissions")
}

// ============================================
// SESSION & TOKEN (기존 유지, FK 타입 변경)
// ============================================

model Session {
  id         Int      @id @default(autoincrement())
  userId     String
  token      String   @unique
  userAgent  String?
  ip         String?
  deviceType String?
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([token])
  @@map("sessions")
}

model RefreshToken {
  id        Int       @id @default(autoincrement())
  userId    String
  token     String    @unique
  family    String?
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([token])
  @@map("refresh_tokens")
}

model PasswordHistory {
  id           Int      @id @default(autoincrement())
  userId       String
  passwordHash String
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@map("password_history")
}

model PasswordResetToken {
  id        Int       @id @default(autoincrement())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

// ============================================
// AUDIT & SECURITY (기존 유지, FK 타입 변경)
// ============================================

model AuditLog {
  id           Int      @id @default(autoincrement())
  userId       String?
  action       String
  resource     String?
  resourceId   String?
  details      String?
  ip           String?
  userAgent    String?
  status       String
  errorMessage String?
  createdAt    DateTime @default(now())

  user User? @relation(fields: [userId], references: [userId], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([resource, resourceId])
  @@index([status])
  @@map("audit_logs")
}

model SecuritySetting {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String
  type        String
  description String?
  updatedAt   DateTime @updatedAt

  @@map("security_settings")
}

// ============================================
// 선분 이력 테이블 (SCD Type 2) - 마스터 8개
// ============================================

model SystemHistory {
  historyId   Int       @id @default(autoincrement()) @map("id")
  systemId    String
  name        String
  domain      String
  description String?
  isActive    Boolean
  validFrom   DateTime  @default(now())
  validTo     DateTime?
  changeType  String    // CREATE, UPDATE, DELETE
  changedBy   String?

  @@index([systemId, validFrom])
  @@index([validTo])
  @@map("system_history")
}

model UserHistory {
  historyId          Int       @id @default(autoincrement()) @map("id")
  userId             String
  email              String
  name               String
  phone              String?
  department         String?
  isActive           Boolean
  isLocked           Boolean
  mustChangePassword Boolean
  validFrom          DateTime  @default(now())
  validTo            DateTime?
  changeType         String
  changedBy          String?

  @@index([userId, validFrom])
  @@index([validTo])
  @@map("user_history")
}

model MenuSetHistory {
  historyId   Int       @id @default(autoincrement()) @map("id")
  menuSetId   Int
  systemId    String
  menuSetCd   String
  name        String
  description String?
  isDefault   Boolean
  isActive    Boolean
  validFrom   DateTime  @default(now())
  validTo     DateTime?
  changeType  String
  changedBy   String?

  @@index([menuSetId, validFrom])
  @@index([validTo])
  @@map("menu_set_history")
}

model MenuHistory {
  historyId  Int       @id @default(autoincrement()) @map("id")
  menuId     Int
  systemId   String
  menuCd     String
  name       String
  category   String
  path       String?
  icon       String?
  sortOrder  String
  isActive   Boolean
  validFrom  DateTime  @default(now())
  validTo    DateTime?
  changeType String
  changedBy  String?

  @@index([menuId, validFrom])
  @@index([validTo])
  @@map("menu_history")
}

model RoleGroupHistory {
  historyId   Int       @id @default(autoincrement()) @map("id")
  roleGroupId Int
  systemId    String
  roleGroupCd String
  name        String
  description String?
  isActive    Boolean
  validFrom   DateTime  @default(now())
  validTo     DateTime?
  changeType  String
  changedBy   String?

  @@index([roleGroupId, validFrom])
  @@index([validTo])
  @@map("role_group_history")
}

model RoleHistory {
  historyId    Int       @id @default(autoincrement()) @map("id")
  roleId       Int
  systemId     String
  parentRoleId Int?
  roleCd       String
  name         String
  description  String?
  level        Int
  isSystem     Boolean
  isActive     Boolean
  validFrom    DateTime  @default(now())
  validTo      DateTime?
  changeType   String
  changedBy    String?

  @@index([roleId, validFrom])
  @@index([validTo])
  @@map("role_history")
}

model PermissionHistory {
  historyId    Int       @id @default(autoincrement()) @map("id")
  permissionId Int
  systemId     String
  menuId       Int?
  permissionCd String
  name         String
  config       String
  description  String?
  isActive     Boolean
  validFrom    DateTime  @default(now())
  validTo      DateTime?
  changeType   String
  changedBy    String?

  @@index([permissionId, validFrom])
  @@index([validTo])
  @@map("permission_history")
}

model SecuritySettingHistory {
  historyId   Int       @id @default(autoincrement()) @map("id")
  settingId   Int
  key         String
  value       String
  type        String
  description String?
  validFrom   DateTime  @default(now())
  validTo     DateTime?
  changeType  String
  changedBy   String?

  @@index([settingId, validFrom])
  @@index([validTo])
  @@map("security_setting_history")
}

// ============================================
// 선분 이력 테이블 (SCD Type 2) - 매핑 5개
// ============================================

model MenuSetMenuHistory {
  historyId  Int       @id @default(autoincrement()) @map("id")
  menuSetId  Int
  menuId     Int
  validFrom  DateTime  @default(now())
  validTo    DateTime?
  changeType String    // ASSIGN, REVOKE
  changedBy  String?

  @@index([menuSetId, validFrom])
  @@index([menuId, validFrom])
  @@index([validTo])
  @@map("menu_set_menu_history")
}

model UserSystemMenuSetHistory {
  historyId  Int       @id @default(autoincrement()) @map("id")
  userId     String
  systemId   String
  menuSetId  Int
  validFrom  DateTime  @default(now())
  validTo    DateTime?
  changeType String    // ASSIGN, UPDATE, REVOKE
  changedBy  String?

  @@index([userId, validFrom])
  @@index([validTo])
  @@map("user_system_menu_set_history")
}

model UserRoleGroupHistory {
  historyId   Int       @id @default(autoincrement()) @map("id")
  userId      String
  roleGroupId Int
  validFrom   DateTime  @default(now())
  validTo     DateTime?
  changeType  String    // ASSIGN, REVOKE
  changedBy   String?

  @@index([userId, validFrom])
  @@index([roleGroupId, validFrom])
  @@index([validTo])
  @@map("user_role_group_history")
}

model RoleGroupRoleHistory {
  historyId   Int       @id @default(autoincrement()) @map("id")
  roleGroupId Int
  roleId      Int
  validFrom   DateTime  @default(now())
  validTo     DateTime?
  changeType  String    // ASSIGN, REVOKE
  changedBy   String?

  @@index([roleGroupId, validFrom])
  @@index([roleId, validFrom])
  @@index([validTo])
  @@map("role_group_role_history")
}

model RolePermissionHistory {
  historyId    Int       @id @default(autoincrement()) @map("id")
  roleId       Int
  permissionId Int
  validFrom    DateTime  @default(now())
  validTo      DateTime?
  changeType   String    // ASSIGN, REVOKE
  changedBy    String?

  @@index([roleId, validFrom])
  @@index([permissionId, validFrom])
  @@index([validTo])
  @@map("role_permission_history")
}
